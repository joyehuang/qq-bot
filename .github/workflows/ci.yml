name: CI/CD - æ™ºèƒ½æ£€æŸ¥ä¸éƒ¨ç½²

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/${{ github.repository_owner }}

jobs:
  # æ£€æµ‹å“ªäº›æ¨¡å—å‘ç”Ÿäº†å˜æ›´
  detect-changes:
    name: æ£€æµ‹å˜æ›´
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    outputs:
      bot: ${{ steps.filter.outputs.bot }}
      admin-server: ${{ steps.filter.outputs.admin-server }}
      admin-web: ${{ steps.filter.outputs.admin-web }}
    steps:
      - name: ğŸ“¦ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ” æ£€æµ‹æ–‡ä»¶å˜æ›´
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            bot:
              - 'src/**'
              - 'prisma/**'
              - 'package*.json'
              - 'Dockerfile'
              - 'tsconfig.json'
            admin-server:
              - 'admin/server/**'
              - 'prisma/**'
            admin-web:
              - 'admin/web/**'

  # Bot ä¸»ç¨‹åºç±»å‹æ£€æŸ¥
  check-bot:
    name: ç±»å‹æ£€æŸ¥ - Bot
    needs: detect-changes
    if: needs.detect-changes.outputs.bot == 'true'
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: "file:./dev.db"
    steps:
      - name: ğŸ“¦ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸŸ¢ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¥ å®‰è£…ä¾èµ–
        run: npm ci

      - name: ğŸ”§ ç”Ÿæˆ Prisma Client
        run: npx prisma generate

      - name: ğŸ” TypeScript ç¼–è¯‘æ£€æŸ¥
        run: npx tsc --noEmit

  # Admin Server ç±»å‹æ£€æŸ¥
  check-admin-server:
    name: ç±»å‹æ£€æŸ¥ - Admin Server
    needs: detect-changes
    if: needs.detect-changes.outputs.admin-server == 'true'
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: "file:./dev.db"
    steps:
      - name: ğŸ“¦ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸŸ¢ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¥ å®‰è£… Bot ä¾èµ–ï¼ˆç”Ÿæˆ Prisma Clientï¼‰
        run: npm ci

      - name: ğŸ”§ ç”Ÿæˆ Prisma Client
        run: npx prisma generate

      - name: ğŸ“¥ å®‰è£… Admin Server ä¾èµ–
        working-directory: admin/server
        run: npm ci

      - name: ğŸ” TypeScript ç¼–è¯‘æ£€æŸ¥
        working-directory: admin/server
        run: npx tsc --noEmit

  # Admin Web ç±»å‹æ£€æŸ¥
  check-admin-web:
    name: ç±»å‹æ£€æŸ¥ - Admin Web
    needs: detect-changes
    if: needs.detect-changes.outputs.admin-web == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¦ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸŸ¢ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¥ å®‰è£… Admin Web ä¾èµ–
        working-directory: admin/web
        run: npm ci

      - name: ğŸ” TypeScript ç¼–è¯‘æ£€æŸ¥
        working-directory: admin/web
        run: npx vue-tsc --noEmit

  # æ„å»ºå¹¶æ¨é€ Bot é•œåƒ
  build-bot:
    name: æ„å»ºé•œåƒ - Bot
    needs: [detect-changes, check-bot]
    if: |
      always() &&
      needs.detect-changes.outputs.bot == 'true' &&
      (needs.check-bot.result == 'success' || needs.check-bot.result == 'skipped')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: ğŸ“¦ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ” ç™»å½•åˆ° GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“ æå–é•œåƒå…ƒæ•°æ®
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_PREFIX }}/qq-bot
          tags: |
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ğŸ”¨ æ„å»ºå¹¶æ¨é€é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # æ„å»ºå¹¶æ¨é€ Admin Server é•œåƒ
  build-admin-server:
    name: æ„å»ºé•œåƒ - Admin Server
    needs: [detect-changes, check-admin-server]
    if: |
      always() &&
      needs.detect-changes.outputs.admin-server == 'true' &&
      (needs.check-admin-server.result == 'success' || needs.check-admin-server.result == 'skipped')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: ğŸ“¦ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ” ç™»å½•åˆ° GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“ æå–é•œåƒå…ƒæ•°æ®
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_PREFIX }}/qq-bot-admin-server
          tags: |
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ğŸ”¨ æ„å»ºå¹¶æ¨é€é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./admin/server/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # æ„å»ºå¹¶æ¨é€ Admin Web é•œåƒ
  build-admin-web:
    name: æ„å»ºé•œåƒ - Admin Web
    needs: [detect-changes, check-admin-web]
    if: |
      always() &&
      needs.detect-changes.outputs.admin-web == 'true' &&
      (needs.check-admin-web.result == 'success' || needs.check-admin-web.result == 'skipped')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: ğŸ“¦ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ” ç™»å½•åˆ° GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“ æå–é•œåƒå…ƒæ•°æ®
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_PREFIX }}/qq-bot-admin-web
          tags: |
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ğŸ”¨ æ„å»ºå¹¶æ¨é€é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: ./admin/web
          file: ./admin/web/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # éƒ¨ç½²åˆ° EC2
  deploy:
    name: éƒ¨ç½²åˆ° EC2
    needs: [detect-changes, build-bot, build-admin-server, build-admin-web]
    if: |
      always() &&
      github.event_name == 'push' &&
      github.ref == 'refs/heads/main' &&
      (
        needs.detect-changes.outputs.bot == 'true' ||
        needs.detect-changes.outputs.admin-server == 'true' ||
        needs.detect-changes.outputs.admin-web == 'true'
      )
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¦ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“‹ æ˜¾ç¤ºæäº¤ä¿¡æ¯
        run: |
          echo "éƒ¨ç½²æäº¤: ${{ github.sha }}"
          echo "æäº¤è€…: ${{ github.actor }}"
          echo "æäº¤ä¿¡æ¯: ${{ github.event.head_commit.message }}"
          echo "æ›´æ–°çš„æœåŠ¡:"
          echo "  - Bot: ${{ needs.detect-changes.outputs.bot }}"
          echo "  - Admin Server: ${{ needs.detect-changes.outputs.admin-server }}"
          echo "  - Admin Web: ${{ needs.detect-changes.outputs.admin-web }}"

      - name: ğŸš€ éƒ¨ç½²åˆ° EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: UPDATE_BOT,UPDATE_ADMIN_SERVER,UPDATE_ADMIN_WEB,GITHUB_REPOSITORY_OWNER
          script: |
            export UPDATE_BOT="${{ needs.detect-changes.outputs.bot }}"
            export UPDATE_ADMIN_SERVER="${{ needs.detect-changes.outputs.admin-server }}"
            export UPDATE_ADMIN_WEB="${{ needs.detect-changes.outputs.admin-web }}"
            export GITHUB_REPOSITORY_OWNER="${{ github.repository_owner }}"
            /home/ubuntu/deploy-qqbot.sh

      - name: âœ… éƒ¨ç½²å®Œæˆ
        run: |
          echo "ğŸ‰ QQ Bot å·²æˆåŠŸéƒ¨ç½²åˆ°æœåŠ¡å™¨ï¼"
          echo "æŸ¥çœ‹æ—¥å¿—: docker compose logs -f"
