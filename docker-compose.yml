services:
  napcat:
    image: mlikiowa/napcat-docker:latest
    container_name: napcat
    restart: unless-stopped
    ports:
      - "6099:6099"   # HTTP API
      - "6100:6100"   # WebSocket
    volumes:
      - ./napcat/config:/app/napcat/config
      - ./napcat/data:/app/napcat/data
    environment:
      - NAPCAT_GID=0
      - NAPCAT_UID=0
    mac_address: "02:42:ac:11:00:02"
    stdin_open: true
    tty: true

  bot:
    build: .
    container_name: qq-bot
    restart: unless-stopped
    depends_on:
      - napcat
    volumes:
      - ./prisma:/app/prisma
    environment:
      - WS_URL=ws://napcat:6100
      - DATABASE_URL=file:./dev.db
      - ADMIN_QQ=1462939861
      - REMINDER_GROUP_ID=831907794
      - REMINDER_HOUR=19
      - REMINDER_MINUTE=0
      - REMINDER_TIMEZONE=Australia/Melbourne
      - GITHUB_USERNAME=joyehuang
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - AI_API_KEY=${AI_API_KEY}
      - AI_MODEL=${AI_MODEL:-Qwen/Qwen2.5-7B-Instruct}
    # 等待 napcat 启动后再连接
    command: sh -c "sleep 5 && npx ts-node src/index.ts"

  admin-api:
    build: ./admin/server
    container_name: qq-bot-admin-api
    restart: unless-stopped
    ports:
      - "3001:3001"
    volumes:
      - ./prisma:/app/prisma
    environment:
      - NODE_ENV=production
      - DATABASE_URL=file:../prisma/dev.db
      - ADMIN_USERNAME=${ADMIN_USERNAME:-admin}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
      - PORT=3001

  admin-web:
    build: ./admin/web
    container_name: qq-bot-admin-web
    restart: unless-stopped
    ports:
      - "8080:80"
    depends_on:
      - admin-api
